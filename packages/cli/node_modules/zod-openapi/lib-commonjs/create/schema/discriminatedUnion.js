"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.mapDiscriminator = exports.createDiscriminatedUnionSchema = void 0;
const zod_1 = require("zod");
const _1 = require(".");
const createDiscriminatedUnionSchema = (zodDiscriminatedUnion, state) => {
    const options = zodDiscriminatedUnion.options;
    const schemas = options.map((option) => (0, _1.createSchemaOrRef)(option, state));
    const discriminator = (0, exports.mapDiscriminator)(schemas, options, zodDiscriminatedUnion.discriminator);
    return {
        oneOf: schemas,
        ...(discriminator && { discriminator }),
    };
};
exports.createDiscriminatedUnionSchema = createDiscriminatedUnionSchema;
const mapDiscriminator = (schemas, zodObjects, discriminator) => {
    if (typeof discriminator !== 'string') {
        return undefined;
    }
    const mapping = {};
    for (const [index, zodObject] of zodObjects.entries()) {
        const schema = schemas[index];
        const componentSchemaRef = '$ref' in schema ? schema?.$ref : undefined;
        if (!componentSchemaRef) {
            return undefined;
        }
        const value = zodObject.shape[discriminator];
        if (value instanceof zod_1.ZodEnum) {
            for (const enumValue of value._def.values) {
                mapping[enumValue] = componentSchemaRef;
            }
            continue;
        }
        const literalValue = (value?._def).value;
        if (typeof literalValue !== 'string') {
            throw new Error(`Discriminator ${discriminator} could not be found in one of the values of a discriminated union`);
        }
        mapping[literalValue] = componentSchemaRef;
    }
    return {
        propertyName: discriminator,
        mapping,
    };
};
exports.mapDiscriminator = mapDiscriminator;
//# sourceMappingURL=discriminatedUnion.js.map